name: Mommy Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. ã€æ ¸å¿ƒã€‘æè‡´ç¼“å­˜ï¼šä¿ä½ 43 åˆ†é’Ÿçš„ NDK (C++) ç¼–è¯‘äº§ç‰©
      - name: âš¡ æ¢å¤ NDK ä¸ Gradle ç¼–è¯‘ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            TMessagesProj/external/webrtc/out
            TMessagesProj/external/tgnet/out
            TMessagesProj/build
            ~/.gradle/caches
            ~/.gradle/wrapper
          # æ³¨æ„ï¼šå»æ‰äº† BuildVars.java å…³è”ï¼Œç¡®ä¿ API ä¿®æ”¹ä¸ä¼šå¯¼è‡´ç¼“å­˜å¤±æ•ˆ
          key: ${{ runner.os }}-ndk-v43-ultra-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-ndk-v43-ultra-

      - name: ğŸ› ï¸ ç»ˆæå…¨è‡ªåŠ¨ï¼šAPI+åå­—+åŒ…å+32å€é€Ÿ+7Gå†…å­˜
        run: |
          # A. æ³¨å…¥ API å‡­æ® (37274250)
          API_ID="37274250"
          API_HASH="5205cbdae6cecc6ce1bd494b5685fe16"
          find TMessagesProj/src/main/java/org/telegram/messenger -name "BuildVars.java" -exec sed -i "s/public static int APP_ID = .*/public static int APP_ID = $API_ID;/g" {} +
          find TMessagesProj/src/main/java/org/telegram/messenger -name "BuildVars.java" -exec sed -i "s/public static String APP_HASH = .*/public static String APP_HASH = \"$API_HASH\";/g" {} +

          # B. ä¿®æ”¹ APP åå­—ä¸å…¨é‡åŒ…å (org.mommy.messenger)
          find TMessagesProj/src/main/res -name "strings.xml" -exec sed -i 's#<string name="AppName">Telegram</string>#<string name="AppName">Mommy Messenger</string>#g' {} +
          sed -i 's/applicationId .*/applicationId "org.mommy.messenger"/' TMessagesProj/build.gradle
          find TMessagesProj/src/main -name "AndroidManifest.xml" -exec sed -i 's/package="org.telegram.messenger"/package="org.mommy.messenger"/g' {} +
          
          # æš´åŠ›æ›¿æ¢å…¨æºç ä¸­çš„åŒ…åå¼•ç”¨ï¼Œé˜²æ­¢ R æ–‡ä»¶æŠ¥é”™
          find TMessagesProj/src/main/java -name "*.java" -exec sed -i 's/org.telegram.messenger/org.mommy.messenger/g' {} +

          # C. âš¡ å¼€å¯ 32 å€é€Ÿå¹¶è¡Œæµä¸ 7G å¤§å†…å­˜æ”¯æŒè¡¥ä¸
          # è·¯å¾„å·²éšåŒ…åæ›´æ”¹ä¸º org.mommy.messenger
          find TMessagesProj/src/main/java/org/mommy/messenger -name "FileLoader.java" -exec sed -i 's/private int maxConnections = .*/private int maxConnections = 32;/g' {} +
          find TMessagesProj/src/main/java/org/mommy/messenger -name "FileLoader.java" -exec sed -i 's/return premium ? .*/return 32;/g' {} +
          find TMessagesProj/src/main/java/org/mommy/messenger -name "UserConfig.java" -exec sed -i 's/public boolean isPremium() {/public boolean isPremium() { return true;/g' {} +
          # å¼€å¯ Android å¤§å †å†…å­˜æ¨¡å¼
          find TMessagesProj/src/main -name "AndroidManifest.xml" -exec sed -i 's/<application/<application android:largeHeap="true" android:hardwareAccelerated="true"/g' {} +

          # D. ä¾èµ–æ³¨å…¥ä¸ç¯å¢ƒä¿®å¤ (API 33 + 32ä½æ¶æ„)
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" > TMessagesProj/google-services.json
          echo 'dependencies { implementation "com.google.firebase:firebase-common:21.0.0"; implementation "com.google.firebase:firebase-messaging:24.0.0"; implementation "com.google.android.gms:play-services-base:18.3.0" }' >> TMessagesProj/build.gradle
          echo 'afterEvaluate { tasks.matching { it.name.contains("googleServices") }.all { enabled = false } }' >> TMessagesProj/build.gradle
          
          sed -i 's/targetSdkVersion .*/targetSdkVersion 33/' TMessagesProj/build.gradle
          sed -i '/abiFilters/c\            abiFilters "armeabi-v7a", "arm64-v8a"' TMessagesProj/build.gradle

      - name: ğŸ—ï¸ è¿è¡Œ 7G å¤§å†…å­˜ç¼–è¯‘æ‰“åŒ…
        env:
          # åˆ†é… 7GB ç‰©ç†å†…å­˜ç»™ JVMï¼Œå½»åº•è§£å†³æ‰“åŒ… OOM
          _JAVA_OPTIONS: "-Xmx7g -Xms2g -XX:MaxMetaspaceSize=1g"
          GRADLE_OPTS: "-Dorg.gradle.jvmargs='-Xmx7g -XX:MaxMetaspaceSize=1g -Dfile.encoding=UTF-8'"
        run: ./gradlew assembleDebug --stacktrace --no-daemon

      - name: ğŸ“¤ ä¸Šä¼ æœ€ç»ˆç‰ˆ APK
        uses: actions/upload-artifact@v4
        with:
          name: Mommy-Messenger-Final-Ultra
          path: TMessagesProj/build/outputs/apk/debug/*.apk
          compression-level: 0
