name: Build Mommy Turbo Vacuum (No Google)
on:
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  build:
    runs-on: ubuntu-latest
    # è®¾ç½®æƒé™ä»¥ç¡®ä¿èƒ½å¤Ÿä¸Šä¼ äº§ç‰©
    permissions:
      contents: read
      actions: write

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: recursive # ç¡®ä¿å­æ¨¡å—ï¼ˆå¦‚ JNI ç›¸å…³ä»£ç ï¼‰ä¹Ÿè¢«æ£€å‡º

      - name: ğŸ› ï¸ æºç ç‰©ç†é‡æ„ (å…¨é‡ä¿®å¤æœ€ç»ˆç‰ˆ)
        run: |
          echo "ğŸš€ å¼€å§‹æœ€ç»ˆç‰©ç†é‡æ„ï¼Œè¡¥å…¨ Extra ç±»å¹¶æ³¨å…¥ Turbo è¡¥ä¸..."

          # 1. å˜é‡å®šä¹‰
          TARGET_ID="org.mommy.messenger"

          # 2. æ³¨å…¥å…¨å±€å±æ€§ (åˆ©ç”¨ properties æ–‡ä»¶æœ€é«˜ä¼˜å…ˆçº§è§„é¿å˜é‡ä¸¢å¤±)
          cat <<EOF > gradle.properties
          org.gradle.jvmargs=-Xmx6144m -XX:MaxMetaspaceSize=1024m -Dfile.encoding=UTF-8
          org.gradle.parallel=false
          org.gradle.configureondemand=true
          APP_ID=37274250
          APP_HASH=5205cbdae6cecc6ce1bd494b5685fe16
          APP_PACKAGE=$TARGET_ID
          TG_APP_PACKAGE=$TARGET_ID
          APP_VERSION_CODE=1000
          APP_VERSION_NAME=1.0.0
          TG_APP_VERSION_CODE=1000
          TG_APP_VERSION_NAME=1.0.0
          TG_APP_ID=37274250
          TG_APP_HASH=5205cbdae6cecc6ce1bd494b5685fe16
          EOF

          # 3. ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºè¡Œåˆ›å»ºä¸€ä¸ª Extra.java
          # è§£å†³ "cannot find symbol: variable Extra" æŠ¥é”™ï¼Œé”å®š Direct æ¨¡å¼
          mkdir -p TMessagesProj/src/main/java/tw/nekomimi/nekogram/
          cat <<EOF > TMessagesProj/src/main/java/tw/nekomimi/nekogram/Extra.java
          package tw.nekomimi.nekogram;
          public class Extra {
              public static int APP_ID = 37274250;
              public static String APP_HASH = "5205cbdae6cecc6ce1bd494b5685fe16";
              public static String PLAYSTORE_APP_URL = "https://play.google.com/store/apps/details?id=$TARGET_ID";
              public static boolean isDirectApp() { return true; }
              public static boolean isBeta() { return false; }
          }
          EOF

          # 4. æš´åŠ›æ³¨å…¥ 32 çº¿ç¨‹ Turbo è¡¥ä¸
          # æ¨¡ç³ŠåŒ¹é…ç©ºæ ¼å’Œæ•°å€¼ï¼Œç¡®ä¿ 100% æ›¿æ¢æˆåŠŸ
          find TMessagesProj/ -name "FileLoader.java" -exec sed -i 's/currentUploadOperationsCount[[:space:]]*<[[:space:]]*[0-9]*/currentUploadOperationsCount < 32/g' {} +
          find TMessagesProj/ -name "FileLoadOperation.java" -exec sed -i 's/currentDownloadOperationsCount[[:space:]]*<[[:space:]]*[0-9]*/currentDownloadOperationsCount < 32/g' {} +

          # 5. ç‰©ç†åˆ‡é™¤ Google æœåŠ¡ (å±è”½æ‰€æœ‰ gms ä¾èµ–é˜²æ­¢ç¼–è¯‘å†²çª)
          find . -name "build.gradle" -exec sed -i '/google-services/d' {} +
          find . -name "build.gradle" -exec sed -i '/com.google.gms/d' {} +

          # 6. ç²¾å‡†é”å®šåŒ…å
          find . -name "build.gradle" -exec sed -i "s/applicationId \".*\"/applicationId \"$TARGET_ID\"/g" {} +

          # 7. åº”ç”¨åç§°æ›´å (Nekogram -> Mommy)
          find . -name "strings.xml" -exec sed -i 's/Nekogram/Mommy/g' {} +
          
          echo "âœ… æºç é‡æ„å®Œæˆï¼Œæ‰€æœ‰è¡¥ä¸å·²å°±ä½ã€‚"

      - name: â˜• è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: ğŸ—ï¸ æ‰§è¡Œ Gradle ç¼–è¯‘ (æé™å†…å­˜å•çº¿ç¨‹)
        run: |
          chmod +x gradlew
          # å¯¼å‡º Java é€‰é¡¹ï¼Œç¡®ä¿ç¼–è¯‘å™¨æœ¬èº«æ‹¥æœ‰ 6GB å†…å­˜
          export JAVA_OPTS="-Xmx6144m"
          
          ./gradlew assembleDebug \
            --no-daemon \
            --no-parallel \
            -x lint \
            -x test \
            -x extractDebugAnnotations \
            -x lintVitalRelease \
            -PapplicationId="org.mommy.messenger"

      - name: ğŸ“¦ å¯¼å‡ºæˆå“ APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Mommy-Turbo-V13-Final
          path: TMessagesProj_App/build/outputs/apk/debug/*.apk
