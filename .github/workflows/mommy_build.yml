name: Build Mommy Turbo Vacuum (No Google)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ æºç ç‰©ç†é‡æ„ (å…¨é‡å˜é‡æ³¨å…¥)
        run: |
          echo "ğŸš€ å¼€å§‹è¡¥å…¨æ‰€æœ‰å¯èƒ½çš„å˜é‡..."

          # 1. å˜é‡å®šä¹‰
          A="org"; B="mommy"; C="messenger"
          TARGET_ID="${A}.${B}.${C}"

          # 2. ã€æ ¸å¿ƒä¿®å¤ã€‘è¿½åŠ æ‰€æœ‰å¯èƒ½ç¼ºå¤±çš„å˜é‡åˆ°æ–‡ä»¶æœ«å°¾
          # åŒæ—¶è¡¥é½ APP_... å’Œ TG_APP_... ä¸¤ç§æ ¼å¼
          cat <<EOF >> TMessagesProj/build.gradle

          ext.APP_ID = 37274250
          ext.APP_HASH = '5205cbdae6cecc6ce1bd494b5685fe16'
          ext.APP_VERSION_CODE = 1000
          ext.APP_VERSION_NAME = '1.0.0'
          ext.TG_APP_VERSION_CODE = 1000
          ext.TG_APP_VERSION_NAME = '1.0.0'
          ext.TG_APP_ID = 37274250
          ext.TG_APP_HASH = '5205cbdae6cecc6ce1bd494b5685fe16'
          EOF

          cat <<EOF >> TMessagesProj_App/build.gradle

          ext.APP_VERSION_CODE = 1000
          ext.APP_VERSION_NAME = '1.0.0'
          ext.TG_APP_VERSION_CODE = 1000
          ext.TG_APP_VERSION_NAME = '1.0.0'
          EOF

          # 3. å½»åº•åˆ‡é™¤ Google æœåŠ¡
          sed -i '/com.google.gms.google-services/d' TMessagesProj_App/build.gradle
          sed -i '/google-services/d' TMessagesProj_App/build.gradle

          # 4. ç²¾å‡†é”å®šåŒ…å
          find . -name "build.gradle" -exec sed -i "s/applicationId \".*\"/applicationId \"$TARGET_ID\"/g" {} +
          find . -name "build.gradle" -exec sed -i "s/applicationIdSuffix .*/applicationIdSuffix \"\"/g" {} +
          find . -name "build.gradle" -exec sed -i 's/\.beta//g' {} +

          # 5. æ³¨å…¥ 32 çº¿ç¨‹ Turbo è¡¥ä¸
          find TMessagesProj/ -name "FileLoader.java" -exec sed -i 's/currentUploadOperationsCount < [0-9]*/currentUploadOperationsCount < 32/g' {} +
          find TMessagesProj/ -name "FileLoadOperation.java" -exec sed -i 's/currentDownloadOperationsCount < [0-9]*/currentDownloadOperationsCount < 32/g' {} +

          # 6. é”å®š Java å±‚ API å‚æ•°
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.APP_ID/37274250/g' "{}" +
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.APP_HASH/"5205cbdae6cecc6ce1bd494b5685fe16"/g' "{}" +

          # 7. åº”ç”¨æ›´å
          find . -name "strings.xml" -exec sed -i 's/Nekogram/Mommy/g' {} +

          echo "âœ… å…¨é‡å˜é‡è¡¥å…¨å®Œæˆã€‚"

      - name: â˜• è®¾ç½® JDK 21 (é…ç½®å¤§å†…å­˜)
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: ğŸ—ï¸ æ‰§è¡Œ Gradle ç¼–è¯‘
        run: |
          chmod +x gradlew
          
          # å¼ºåˆ¶å†…å­˜
          echo "org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m" > gradle.properties
          
          # æ‰§è¡Œç¼–è¯‘ï¼Œå‘½ä»¤è¡Œä¹Ÿè¡¥ä¸Š TG_ å‰ç¼€å‚æ•°
          ./gradlew assembleDebug \
            -PAPP_VERSION_CODE=1000 \
            -PAPP_VERSION_NAME="1.0.0" \
            -PTG_APP_VERSION_CODE=1000 \
            -PTG_APP_VERSION_NAME="1.0.0" \
            -x lint \
            -x test \
            -x extractDebugAnnotations \
            -PapplicationId="org.mommy.messenger" \
            --no-daemon

      - name: ğŸ“¦ å¯¼å‡ºæœ€ç»ˆæˆå“ APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Mommy-Turbo-Final-V7
          path: TMessagesProj_App/build/outputs/apk/debug/*.apk
