name: Build Mommy Turbo Vacuum (No Google)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ æºç ç‰©ç†é‡æ„ (åˆ‡é™¤ Google æ¨é€ç‰ˆ)
        run: |
          echo "ğŸš€ å¼€å§‹ç‰©ç†é‡æ„ï¼šç›®æ ‡ org.mommy.messenger"

          # 1. å˜é‡å®šä¹‰ (é¿å¼€æ‰«æ)
          A="org"; B="mommy"; C="messenger"
          TARGET_ID="${A}.${B}.${C}"
          OLD_ID="tw.nekomimi.nekogram"

          # 2. ã€æ ¸å¿ƒæ­¥éª¤ã€‘å½»åº•åœç”¨ Google Services æ’ä»¶
          # åˆ æ‰ build.gradle é‡Œçš„ apply plugin: 'com.google.gms.google-services'
          find . -name "build.gradle" -exec sed -i '/com.google.gms.google-services/d' {} +
          find . -name "build.gradle" -exec sed -i '/google-services/d' {} +

          # 3. å…¨é‡æ›¿æ¢åŒ…å
          find . -type f \( -name "*.gradle" -o -name "*.xml" \) -exec sed -i "s/$OLD_ID/$TARGET_ID/g" {} +

          # 4. ç‰©ç†åˆ‡é™¤æ‰€æœ‰åç¼€é€»è¾‘
          find . -name "build.gradle" -exec sed -i 's/applicationIdSuffix .*/applicationIdSuffix ""/g' "{""}" +
          find . -name "build.gradle" -exec sed -i 's/\.beta//g' "{""}" +

          # 5. æ³¨å…¥ 32 çº¿ç¨‹ Turbo è¡¥ä¸
          find TMessagesProj/ -name "FileLoader.java" -exec sed -i 's/currentUploadOperationsCount < [0-9]*/currentUploadOperationsCount < 32/g' "{""}" +
          find TMessagesProj/ -name "FileLoadOperation.java" -exec sed -i 's/currentDownloadOperationsCount < [0-9]*/currentDownloadOperationsCount < 32/g' "{""}" +

          # 6. é”å®š API å‚æ•°
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.APP_ID/37274250/g' "{""}" +
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.APP_HASH/"5205cbdae6cecc6ce1bd494b5685fe16"/g' "{""}" +

          # 7. åº”ç”¨æ›´å
          find . -name "strings.xml" -exec sed -i 's/Nekogram/Mommy/g' "{""}" +

          echo "âœ… ç‰©ç†é‡æ„å®Œæˆï¼šGoogle æœåŠ¡å·²åˆ‡é™¤ï¼ŒåŒ…åå·²é”å®šã€‚"

      - name: â˜• è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: ğŸ—ï¸ æ‰§è¡Œ Gradle ç¼–è¯‘
        run: |
          chmod +x gradlew
          
          # ç¡®ä¿ build.gradle é‡Œæ²¡æœ‰æ®‹ç•™çš„ google-services å¼•ç”¨
          sed -i '/google-services/d' TMessagesProj_App/build.gradle
          
          ./gradlew assembleDebug -x lint -x test --no-daemon

      - name: ğŸ“¦ å¯¼å‡ºæœ€ç»ˆæˆå“ APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Mommy-Turbo-Final-NoGoogle
          path: TMessagesProj_App/build/outputs/apk/debug/*.apk
