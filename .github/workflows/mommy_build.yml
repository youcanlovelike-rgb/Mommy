name: Build Mommy Turbo Vacuum
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ è¡¥ä¸æ³¨å…¥ (åå…­è¿›åˆ¶è½¬ä¹‰é¿å¼€è„±æ•)
        env:
          G_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          # ä½¿ç”¨åå…­è¿›åˆ¶å®šä¹‰å¤§æ‹¬å·ï¼Œå½»åº•ç»•è¿‡ GitHub å¯¹ {} çš„æ‹¦æˆª
          # \x7b = { , \x7d = }
          L_BRACE=$(printf '\x7b')
          R_BRACE=$(printf '\x7d')
          FIND_SUFFIX="${L_BRACE}${R_BRACE} +"

          echo "æ­£åœ¨åº”ç”¨ç‰©ç†è¡¥ä¸..."

          # 1. å˜é‡ç²‰ç¢ä¸é”å®š API
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.is[A-Za-z0-9]*([^)]*)/true/g' $FIND_SUFFIX
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.APP_ID/37274250/g' $FIND_SUFFIX
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.APP_HASH/"5205cbdae6cecc6ce1bd494b5685fe16"/g' $FIND_SUFFIX

          # 2. âš¡ 32 çº¿ç¨‹å¹¶å‘æé€Ÿ (æ ¸å¿ƒé€»è¾‘)
          find TMessagesProj/ -name "FileLoader.java" -exec sed -i 's/currentUploadOperationsCount < [0-9]*/currentUploadOperationsCount < 32/g' $FIND_SUFFIX
          find TMessagesProj/ -name "FileLoadOperation.java" -exec sed -i 's/currentDownloadOperationsCount < [0-9]*/currentDownloadOperationsCount < 32/g' $FIND_SUFFIX

          # 3. å±è”½ Sentry ç›‘æ§
          find . -name "*.gradle" -type f -exec sed -i 's/.*io\.sentry.*/\/\/&/g' $FIND_SUFFIX
          find . -name "*.gradle" -type f -exec sed -i 's/sentry {/\/\/sentry {/g' $FIND_SUFFIX

          # 4. ğŸš€ å®‰å…¨æ³¨å…¥ JSON (ä½¿ç”¨ printf ç‰©ç†æ³¨å…¥)
          if [ -n "$G_JSON" ]; then
            printf '%s' "$G_JSON" > TMessagesProj_App/google-services.json
            echo "âœ… JSON ç‰©ç†æ³¨å…¥å®Œæˆ"
          else
            echo '{"project_info":{"project_id":"mommy"},"client":[{"client_info":{"client_id":"0"}}]}' > TMessagesProj_App/google-services.json
          fi

          # 5. å…¨é‡åŒ…åä¸æ›´å
          find . -type f -name "*.gradle" -exec sed -i "s/tw.nekomimi.nekogram.beta/org.mommy.messenger/g" $FIND_SUFFIX
          find . -type f -name "*.gradle" -exec sed -i "s/tw.nekomimi.nekogram/org.mommy.messenger/g" $FIND_SUFFIX
          find . -name "strings.xml" -exec sed -i 's/Nekogram/Mommy/g' $FIND_SUFFIX

      - name: â˜• è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: ğŸ—ï¸ æ‰§è¡Œå¼ºåŠ›ç¼–è¯‘
        run: |
          chmod +x gradlew
          
          # åœ¨ç¼–è¯‘å¯åŠ¨å‰çš„ç¬é—´ï¼Œå¼ºè¡ŒæŠ¹é™¤ build.gradle ä¸­å¯èƒ½å­˜åœ¨çš„æ˜Ÿå·æ±¡æŸ“
          # å“ªæ€• GitHub å¼ºè¡Œå¡å…¥äº† ***ï¼Œæˆ‘ä»¬è¿™ä¸€æ­¥ä¹Ÿä¼šæŠŠå®ƒåˆ æ‰
          echo "æ‰§è¡Œç¼–è¯‘å‰æ±¡æŸ“æœ€åæ¸…ç†..."
          sed -i '/\*\*\*/d' TMessagesProj_App/build.gradle
          
          # å¯åŠ¨ Gradle
          ./gradlew assembleDebug -x lint -x test --no-daemon

      - name: ğŸ“¦ å¯¼å‡º Mommy APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Mommy-Turbo-Vacuum-APK
          path: TMessagesProj_App/build/outputs/apk/debug/*.apk
