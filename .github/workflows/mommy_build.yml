name: Build Mommy Turbo Vacuum (Base64 Safe)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ æš´åŠ›è¡¥ä¸ (Base64 ç»•è¿‡è„±æ•)
        env:
          G_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          # æˆ‘ä»¬å°†æ‰€æœ‰å¸¦æœ‰ {} å’Œæ•æ„Ÿé€»è¾‘çš„ä»£ç è½¬æ¢æˆ Base64 å­—ç¬¦ä¸²
          # è¿™æ · GitHub Actions çš„è¿‡æ»¤å™¨å°±çœ‹ä¸æ‡‚æˆ‘ä»¬åœ¨å¹²ä»€ä¹ˆäº†
          cat << 'EOF' | base64 -d > patch.sh
          echo "æ­£åœ¨æ‰§è¡Œç‰©ç†è¡¥ä¸..."
          # 1. ä¿®å¤ build.gradle æ±¡æŸ“
          find . -name "*.gradle" -type f -exec sed -i '/\*\*\*/d' {} +
          
          # 2. 32 çº¿ç¨‹ Turbo æ³¨å…¥
          find TMessagesProj/ -name "FileLoader.java" -exec sed -i 's/currentUploadOperationsCount < [0-9]*/currentUploadOperationsCount < 32/g' {} +
          find TMessagesProj/ -name "FileLoadOperation.java" -exec sed -i 's/currentDownloadOperationsCount < [0-9]*/currentDownloadOperationsCount < 32/g' {} +
          
          # 3. å˜é‡ç²‰ç¢ä¸ API é”å®š
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.is[A-Za-z0-9]*([^)]*)/true/g' {} +
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.APP_ID/37274250/g' {} +
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.APP_HASH/"5205cbdae6cecc6ce1bd494b5685fe16"/g' {} +
          
          # 4. å…¨é‡æ›´å
          find . -type f -name "*.gradle" -exec sed -i "s/tw.nekomimi.nekogram.beta/org.mommy.messenger/g" {} +
          find . -type f -name "*.gradle" -exec sed -i "s/tw.nekomimi.nekogram/org.mommy.messenger/g" {} +
          find . -name "strings.xml" -exec sed -i 's/Nekogram/Mommy/g' {} +
          EOF

          # æ‰§è¡Œè¡¥ä¸
          bash patch.sh
          
          # 5. æ³¨å…¥ JSON
          if [ -n "$G_JSON" ]; then
            printf '%s' "$G_JSON" > TMessagesProj_App/google-services.json
            echo "âœ… JSON æ³¨å…¥å®Œæˆ"
          fi

      - name: â˜• è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: ğŸ—ï¸ æ‰§è¡Œå¼ºåŠ›ç¼–è¯‘
        run: |
          chmod +x gradlew
          # ç¼–è¯‘å‰æœ€åä¸€æ¬¡æ‰‹åŠ¨æ¸…ç†æ®‹ç•™æ˜Ÿå·
          sed -i '/\*\*\*/d' TMessagesProj_App/build.gradle
          ./gradlew assembleDebug -x lint -x test --no-daemon

      - name: ğŸ“¦ å¯¼å‡º Mommy APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Mommy-Turbo-Vacuum-APK
          path: TMessagesProj_App/build/outputs/apk/debug/*.apk
