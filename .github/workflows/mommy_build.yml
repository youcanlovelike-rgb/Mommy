name: Build Mommy Turbo Vacuum
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ› ï¸ æè‡´ç‰©ç†è„±é’©ï¼šç²‰ç¢æ‰€æœ‰ç›‘æ§ä¸é…ç½®
        run: |
          # 1. å˜é‡ç²‰ç¢ï¼šåˆ‡æ–­æ‰€æœ‰ Extra çš„ç”Ÿå‘½çº¿
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.is[A-Za-z0-9]*([^)]*)/true/g' {} +
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.[A-Za-z0-9_]*DSN/""/g' {} +
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.TWPIC_BOT_USERNAME/"Bot"/g' {} +
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.TLV_URL/"http:\/\/127.0.0.1"/g' {} +
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.getUserInfoBot([^)]*)/null/g' {} +
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.getHelperBot()/null/g' {} +
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.APP_ID/37274250/g' {} +
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.APP_HASH/"5205cbdae6cecc6ce1bd494b5685fe16"/g' {} +

          # 2. ä¾èµ–ä¸é…ç½®æ¸…æ´—ï¼šç§»é™¤ Sentry å’Œ Firebase çš„æ‰€æœ‰ç—•è¿¹ (æ ¸å¿ƒä¿®å¤)
          # ç‰©ç†åˆ é™¤æ‰€æœ‰åŒ…å« sentry, firebase-analytics çš„è¡Œ
          find . -name "*.gradle" -type f -exec sed -i '/io.sentry/d' {} +
          find . -name "*.gradle" -type f -exec sed -i '/firebase-analytics/d' {} +
          find . -name "*.gradle" -type f -exec sed -i '/play-services-measurement/d' {} +
          # æš´åŠ›æ³¨é”€ sentry { ... } é…ç½®å— (è§£å†³æœ¬æ¬¡æŠ¥é”™çš„å…³é”®)
          find . -name "*.gradle" -type f -exec sed -i '/sentry {/,/}/d' {} +
          # ç§»é™¤ sentry æ’ä»¶å¼•å…¥
          find . -name "*.gradle" -type f -exec sed -i '/apply plugin:.*sentry/d' {} +
          find . -name "*.gradle" -type f -exec sed -i '/id.*io.sentry/d' {} +

          # 3. ç½‘ç»œå°æ€ï¼šå°†æ®‹ç•™çš„ç›‘æ§åŸŸåé‡å®šå‘åˆ°æœ¬åœ°
          find . -type f -name "*.java" -exec sed -i 's/https:\/\/sentry\.io/http:\/\/127.0.0.1/g' {} +
          find . -type f -name "*.java" -exec sed -i 's/https:\/\/app-measurement\.com/http:\/\/127.0.0.1/g' {} +

          # 4. âš¡ 32 çº¿ç¨‹å¹¶å‘æé€Ÿ
          find TMessagesProj/ -name "FileLoader.java" -exec sed -i 's/currentUploadOperationsCount < [0-9]*/currentUploadOperationsCount < 32/g' {} +
          find TMessagesProj/ -name "FileLoadOperation.java" -exec sed -i 's/currentDownloadOperationsCount < [0-9]*/currentDownloadOperationsCount < 32/g' {} +
          
          # 5. ğŸš€ å…¨é‡åŒ…åä¸æ›´å
          NEW_APPID="org.mommy.messenger"
          find . -type f -exec sed -i "s/tw.nekomimi.nekogram.beta/$NEW_APPID/g" {} +
          find . -type f -exec sed -i "s/tw.nekomimi.nekogram/$NEW_APPID/g" {} +
          find . -type f -exec sed -i "s/org.nekogram.messenger/$NEW_APPID/g" {} +
          find . -name "strings.xml" -type f -exec sed -i 's/Nekogram/Mommy/g' {} +
          find . -name "strings.xml" -type f -exec sed -i 's/Neko/Mommy/g' {} +

          # 6. æ³¨å…¥å¹¶æ¸…æ´— Google Services JSON
          echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > TMessagesProj_App/google-services.json
          sed -i 's/"ads_id": "[^"]*"/"ads_id": ""/g' TMessagesProj_App/google-services.json
          sed -i 's/"tracking_id": "[^"]*"/"tracking_id": ""/g' TMessagesProj_App/google-services.json

      - name: set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: ğŸ—ï¸ å¼ºåŠ›å‡ºåŒ…
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug -x lint -x test --no-daemon

      - name: ğŸ“¦ å¯¼å‡º Mommy APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Mommy-Turbo-Vacuum-APK
          path: TMessagesProj_App/build/outputs/apk/debug/*.apk
