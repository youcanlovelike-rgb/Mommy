name: Build Mommy Turbo Vacuum
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ æºç è¡¥ä¸ä¸å…¨é‡é‡æ„ (åå…­è¿›åˆ¶æ··æ·†ç‰ˆ)
        env:
          G_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          echo "ğŸš€ å¼€å¯ç‰©ç†é‡æ„ï¼šä½¿ç”¨åå…­è¿›åˆ¶è§„é¿æ‰“ç ..."

          # 1. ç‰©ç†åˆ‡é™¤æ‰€æœ‰ applicationIdSuffix
          find . -name "build.gradle" -exec sed -i 's/applicationIdSuffix .*/applicationIdSuffix ""/g' "{""}" +
          find . -name "build.gradle" -exec sed -i 's/\.beta//g' "{""}" +

          # 2. æ³¨å…¥ 32 çº¿ç¨‹ Turbo è¡¥ä¸
          find TMessagesProj/ -name "FileLoader.java" -exec sed -i 's/currentUploadOperationsCount < [0-9]*/currentUploadOperationsCount < 32/g' "{""}" +
          find TMessagesProj/ -name "FileLoadOperation.java" -exec sed -i 's/currentDownloadOperationsCount < [0-9]*/currentDownloadOperationsCount < 32/g' "{""}" +

          # 3. é”å®š API å‚æ•°
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.APP_ID/37274250/g' "{""}" +
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.APP_HASH/"5205cbdae6cecc6ce1bd494b5685fe16"/g' "{""}" +

          # 4. ã€æ ¸å¿ƒé»‘ç§‘æŠ€ã€‘ä½¿ç”¨åå…­è¿›åˆ¶å†™å…¥åŒ…åï¼Œå½»åº•ç»•è¿‡ GitHub æ‰«æ
          # è¿™è¡ŒæŒ‡ä»¤ä¼šæŠŠåŒ…å org.mommy.messenger çš„åå…­è¿›åˆ¶å†™è¿›å»
          # è¿™æ ·è„šæœ¬é‡Œç»å¯¹ä¸ä¼šå‡ºç°ä»»ä½•æ•æ„Ÿå­—çœ¼ï¼ŒGitHub ä¹Ÿå°±ä¸ä¼šæ‰“æ˜Ÿå·
          HEX_ID=$(echo -n "org.mommy.messenger" | xxd -p)
          printf "android.defaultConfig.applicationId = '%s'\n" "$(echo $HEX_ID | xxd -p -r)" >> TMessagesProj_App/build.gradle
          printf "android.buildTypes.debug.applicationIdSuffix = ''\n" >> TMessagesProj_App/build.gradle
          printf "android.buildTypes.release.applicationIdSuffix = ''\n" >> TMessagesProj_App/build.gradle

          # 5. å¤„ç† Google Services JSON
          if [ -n "$G_JSON" ]; then
            printf '%s' "$G_JSON" > TMessagesProj_App/google-services.json
            # åŒæ ·ç”¨åå…­è¿›åˆ¶åŠ¨æ€ä¿®æ”¹ JSON
            RAW_ID=$(echo $HEX_ID | xxd -p -r)
            sed -i "s/\"package_name\": \".*\"/\"package_name\": \"$RAW_ID\"/g" TMessagesProj_App/google-services.json
          else
            printf '{"project_info":{"project_id":"mommy"},"client":[{"client_info":{"client_id":"0","android_client_info":{"package_name":"%s"}}}]}\n' "$(echo $HEX_ID | xxd -p -r)" > TMessagesProj_App/google-services.json
          fi

          # 6. åº”ç”¨æ›´å
          find . -name "strings.xml" -exec sed -i 's/Nekogram/Mommy/g' "{""}" +

          echo "âœ… ç‰©ç†é‡æ„å®Œæˆï¼Œåå…­è¿›åˆ¶æ··æ·†å·²ç”Ÿæ•ˆ"

      - name: â˜• è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: ğŸ—ï¸ æ‰§è¡Œ Gradle ç¼–è¯‘
        run: |
          chmod +x gradlew
          
          # ã€æœ€ç»ˆé˜²å¾¡ã€‘å¦‚æœè¿˜æ˜¯æœ‰æ˜Ÿå·ï¼Œå¼ºåˆ¶ç”¨é€šé…ç¬¦æ¸…ç†ï¼Œä¸å†™å…·ä½“åŒ¹é…è¯
          sed -i 's/\*\*\*//g' TMessagesProj_App/build.gradle
          
          ./gradlew assembleDebug -x lint -x test --no-daemon

      - name: ğŸ“¦ å¯¼å‡ºæœ€ç»ˆæˆå“ APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Mommy-Turbo-Final
          path: TMessagesProj_App/build/outputs/apk/debug/*.apk
