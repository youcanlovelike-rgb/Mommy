name: Build Mommy Turbo Vacuum (V33 Final)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ğŸ› ï¸ æºç ç‰©ç†é‡æ„ (7GBå†…å­˜ + 32çº¿ç¨‹ + å˜é‡è¡¥å®Œ)
        run: |
          echo "ğŸš€ æ­£åœ¨æ‰§è¡Œå…¨é‡ç‰©ç†æ”¹é€ ..."

          TARGET_ID="org.mommy.messenger"

          # 1. ç‰©ç†é”æ­» 7GB å†…å­˜é…ç½®
          cat <<EOF > gradle.properties
          org.gradle.jvmargs=-Xmx7168m -Xms2048m -XX:MaxMetaspaceSize=1024m -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.caching=true
          android.useAndroidX=true
          android.nonTransitiveRClass=true
          APP_ID=37274250
          APP_HASH=5205cbdae6cecc6ce1bd494b5685fe16
          APP_PACKAGE=$TARGET_ID
          TG_APP_PACKAGE=$TARGET_ID
          APP_VERSION_CODE=1000
          APP_VERSION_NAME=1.0.0
          TG_APP_VERSION_CODE=1000
          TG_APP_VERSION_NAME=1.0.0
          TG_APP_ID=37274250
          TG_APP_HASH=5205cbdae6cecc6ce1bd494b5685fe16
          BETA_VERSION=false
          EOF

          # 2. ğŸ”¥ã€æ ¸å¿ƒä¿®å¤ã€‘ç‰©ç†æ³¨å…¥å…¨å±€å˜é‡ä½œç”¨åŸŸ (è§£å†³ unknown property)
          # æˆ‘ä»¬æŠŠæ‰€æœ‰å˜é‡ç›´æ¥é’‰åœ¨æ¯ä¸ª build.gradle çš„ç¬¬ä¸€è¡Œ
          VAR_INJECTION="ext { TG_APP_VERSION_CODE = 1000; TG_APP_VERSION_NAME = '1.0.0'; TG_APP_ID = 37274250; TG_APP_HASH = '5205cbdae6cecc6ce1bd494b5685fe16'; TG_BETA_VERSION = false; APP_ID = 37274250; APP_HASH = '5205cbdae6cecc6ce1bd494b5685fe16'; }"
          find . -name "build.gradle" -exec sed -i "1i $VAR_INJECTION" {} +

          # 3. è¡¥å…¨ Extra.java ç¬¦å·å¯¹é½
          mkdir -p TMessagesProj/src/main/java/tw/nekomimi/nekogram/
          cat <<EOF > TMessagesProj/src/main/java/tw/nekomimi/nekogram/Extra.java
          package tw.nekomimi.nekogram;
          public class Extra {
              public static int APP_ID = 37274250;
              public static String APP_HASH = "5205cbdae6cecc6ce1bd494b5685fe16";
              public static String PLAYSTORE_APP_URL = "https://play.google.com/store/apps/details?id=$TARGET_ID";
              public static String OFFICIAL_CHANNEL = "https://t.me/oksnsksms";
              public static String TRANSLATION_API_KEY = "";
              public static String TRANSLATION_API_ID = "";
              public static boolean isDirectApp() { return true; }
              public static boolean isBeta() { return false; }
              public static String getHelperBot() { return "NekogramBot"; }
              public static boolean isGoogle() { return false; } 
              public static String getAppUpdateUrl() { return ""; }
              public static boolean isSentryEnabled() { return false; }
          }
          EOF

          # 4. ğŸ”¥ã€åŠ é€Ÿè¡¥ä¸ã€‘32 çº¿ç¨‹ Turbo æ³¨å…¥
          find TMessagesProj/ -name "FileLoader.java" -exec sed -i 's/currentUploadOperationsCount[[:space:]]*<[[:space:]]*[0-9]*/currentUploadOperationsCount < 32/g' {} +
          find TMessagesProj/ -name "FileLoadOperation.java" -exec sed -i 's/currentDownloadOperationsCount[[:space:]]*<[[:space:]]*[0-9]*/currentDownloadOperationsCount < 32/g' {} +

          # 5. å¼€å¯ buildConfig å¹¶æ¸…ç† Google æ®‹ç•™
          find . -name "build.gradle" -exec sed -i '/android {/a \    buildFeatures { buildConfig = true }' {} +
          find . -name "build.gradle" -exec sed -i '/google-services/d' {} +
          find . -name "build.gradle" -exec sed -i '/com.google.gms/d' {} +
          
          # 6. åŒ…åã€å‘½åç©ºé—´ã€åº”ç”¨åç§°ç‰©ç†æ›¿æ¢
          find . -name "build.gradle" -exec sed -i "s/applicationId \".*\"/applicationId \"$TARGET_ID\"/g" {} +
          find . -name "build.gradle" -exec sed -i "s/namespace \".*\"/namespace \"$TARGET_ID\"/g" {} +
          find . -name "strings.xml" -exec sed -i 's/Nekogram/Mommy/g' {} +
          find . -name "AndroidManifest.xml" -exec sed -i "s/package=\"[^\"]*\"/package=\"$TARGET_ID\"/g" {} +

      - name: â˜• è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ğŸ˜ è®¾ç½® Gradle (è‡ªåŠ¨å¤„ç†ç½‘ç»œä¸ç‰ˆæœ¬)
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '9.3.1'

      - name: ğŸ—ï¸ æ‰§è¡Œ Gradle ç¼–è¯‘ (7GB æ»¡è½½ + ä»»åŠ¡éš”ç¦»æ¨¡å¼)
        run: |
          chmod +x gradlew
          export JAVA_OPTS="-Xmx7168m"
          ./gradlew clean assembleDebug \
            --no-daemon \
            --parallel \
            --max-workers=4 \
            -x processDebugGoogleServices \
            -x processPlayGoogleServices \
            -x lint -x test -x extractDebugAnnotations \
            -PabiFilters="arm64-v8a"

      - name: ğŸ“¦ å¯¼å‡ºæœ€ç»ˆ Mommy APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Mommy-Turbo-V33-Performance
          path: TMessagesProj_App/build/outputs/apk/debug/*.apk

