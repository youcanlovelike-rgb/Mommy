name: Mommy Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. æ¢å¤ NDK ä¸ Gradle ç¼–è¯‘ç¼“å­˜ (ä¿ä½ä½ é‚£ 43 åˆ†é’Ÿçš„æˆæœ)
      - name: ğŸ“‚ Restore Cache
        uses: actions/cache@v4
        with:
          path: |
            TMessagesProj/external/webrtc/out
            TMessagesProj/external/tgnet/out
            TMessagesProj/build
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-ndk-v43-ultra-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-ndk-v43-ultra-

      # 2. æ ¸å¿ƒå®šåˆ¶æ­¥éª¤ (å·²ä¿®æ­£ XML é€»è¾‘ä¸ç¼©è¿›)
      - name: ğŸ› ï¸ Mommy Customization
        run: |
          # A. API æ³¨å…¥
          sed -i 's/public static int APP_ID = .*/public static int APP_ID = 37274250;/g' TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java
          sed -i 's/public static String APP_HASH = .*/public static String APP_HASH = "5205cbdae6cecc6ce1bd494b5685fe16";/g' TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java

          # B. ä¿®æ”¹ APP åå­—ä¸åŒ…å (ä¿æŒç‰©ç†è·¯å¾„ä¸å˜ï¼Œç¡®ä¿ç¼“å­˜å‘½ä¸­)
          find TMessagesProj/src/main/res -name "strings.xml" -exec sed -i 's/>Telegram</>Mommy Messenger</g' {} +
          sed -i 's/applicationId "org.telegram.messenger"/applicationId "org.mommy.messenger"/' TMessagesProj/build.gradle
          
          # C. âš¡ 32 å€é€Ÿå¹¶è¡Œæµä¸ Premium å¼ºåˆ¶å¼€å¯
          find TMessagesProj/src/main/java/org/telegram/messenger -name "FileLoader.java" -exec sed -i 's/private int maxConnections = .*/private int maxConnections = 32;/g' {} +
          find TMessagesProj/src/main/java/org/telegram/messenger -name "FileLoader.java" -exec sed -i 's/return premium ? .*/return 32;/g' {} +
          find TMessagesProj/src/main/java/org/telegram/messenger -name "UserConfig.java" -exec sed -i 's/public boolean isPremium() {/public boolean isPremium() { return true;/g' {} +
          
          # D. âœ… ä¿®å¤ XML è¯­æ³• (ç²¾å‡†æ’å…¥ï¼Œä¸å†ç ´åæ ‡ç­¾)
          find TMessagesProj/src/main -name "AndroidManifest.xml" -exec sed -i 's/android:name=".TelegramApp"/android:name=".TelegramApp" android:largeHeap="true"/g' {} +

          # E. ğŸ—‘ï¸ å¹²æ‰ 32 ä½ (é”å®š arm64-v8aï¼Œæè‡´æé€Ÿ)
          sed -i '/abiFilters/c\            abiFilters "arm64-v8a"' TMessagesProj/build.gradle

          # F. ç¯å¢ƒè¡¥ä¸
          if [ -n "${{ secrets.GOOGLE_SERVICES_JSON }}" ]; then
            echo "${{ secrets.GOOGLE_SERVICES_JSON }}" > TMessagesProj/google-services.json
          fi
          sed -i 's/targetSdkVersion .*/targetSdkVersion 33/' TMessagesProj/build.gradle

      # 3. è¿è¡Œç¼–è¯‘ (ä½¿ç”¨ 7G å¤§å†…å­˜é…ç½®)
      - name: ğŸ—ï¸ Build APK
        env:
          _JAVA_OPTIONS: "-Xmx7g -Xms2g -XX:MaxMetaspaceSize=1g"
          GRADLE_OPTS: "-Dorg.gradle.jvmargs='-Xmx7g -Xms2g -XX:MaxMetaspaceSize=1g -Dfile.encoding=UTF-8'"
        run: ./gradlew assembleDebug --stacktrace --no-daemon

      # 4. ä¸Šä¼ æœ€ç»ˆç‰ˆ APK
      - name: ğŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Mommy-Messenger-v8a-Speed
          path: TMessagesProj/build/outputs/apk/debug/*.apk
