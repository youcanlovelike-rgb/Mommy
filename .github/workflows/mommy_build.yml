name: Build Mommy Turbo Vacuum
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ æ·±åº¦æ¸…æ´— + æ³¨å…¥æ¨é€ + 32çº¿ç¨‹ Turbo
        env:
          G_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          # 0. è§„é¿ GitHub è„±æ•å¹²æ‰°ï¼šå°† find çš„åç¼€è¿›è¡Œå˜é‡æ‹†è§£
          B1="{"
          B2="}"
          TARGET="${B1}${B2} +"

          # 1. å˜é‡ç²‰ç¢ï¼šé”å®š API ID å¹¶åˆ‡æ–­ç›‘æ§ DSN
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.is[A-Za-z0-9]*([^)]*)/true/g' $TARGET
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.[A-Za-z0-9_]*DSN/""/g' $TARGET
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.TWPIC_BOT_USERNAME/"Bot"/g' $TARGET
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.getUserInfoBot([^)]*)/null/g' $TARGET
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.getHelperBot()/null/g' $TARGET
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.APP_ID/37274250/g' $TARGET
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.APP_HASH/"5205cbdae6cecc6ce1bd494b5685fe16"/g' $TARGET

          # 2. ä¾èµ–æ¸…æ´—ï¼šå±è”½ Sentry ç›‘æ§
          find . -name "*.gradle" -type f -exec sed -i 's/.*io\.sentry.*/\/\/&/g' $TARGET
          find . -name "*.gradle" -type f -exec sed -i 's/sentry {/\/\/sentry {/g' $TARGET

          # 3. ğŸš€ å®‰å…¨æ³¨å…¥ JSON (printf æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œèƒ½é¿å¼€æ˜Ÿå·å¹²æ‰°)
          if [ -n "$G_JSON" ]; then
            printf '%s' "$G_JSON" > TMessagesProj_App/google-services.json
            echo "âœ… Google Services JSON å·²æˆåŠŸå®‰å…¨æ³¨å…¥"
          else
            echo "âš ï¸ Warning: G_JSON å˜é‡ä¸ºç©ºï¼Œæ­£åœ¨ç”Ÿæˆç©ºå£³é˜²æ­¢ç¼–è¯‘æŠ¥é”™"
            echo '{"project_info":{"project_id":"mommy"},"client":[{"client_info":{"client_id":"0"}}]}' > TMessagesProj_App/google-services.json
          fi

          # 4. âš¡ 32 çº¿ç¨‹å¹¶å‘æé€Ÿ (ç‰©ç† Turbo)
          # å¼ºåˆ¶ä¿®æ”¹ FileLoader.java ä¸­çš„å¹¶å‘è®¡æ•°å™¨é€»è¾‘
          find TMessagesProj/ -name "FileLoader.java" -exec sed -i 's/currentUploadOperationsCount < [0-9]*/currentUploadOperationsCount < 32/g' $TARGET
          find TMessagesProj/ -name "FileLoadOperation.java" -exec sed -i 's/currentDownloadOperationsCount < [0-9]*/currentDownloadOperationsCount < 32/g' $TARGET

          # 5. ğŸš€ å…¨é‡åŒ…åä¸æ›´å (Mommy åŒ–)
          NEW_APPID="org.mommy.messenger"
          find . -type f -exec sed -i "s/tw.nekomimi.nekogram.beta/$NEW_APPID/g" $TARGET
          find . -type f -exec sed -i "s/tw.nekomimi.nekogram/$NEW_APPID/g" $TARGET
          find . -name "strings.xml" -type f -exec sed -i 's/Nekogram/Mommy/g' $TARGET
          find . -name "strings.xml" -type f -exec sed -i 's/Neko/Mommy/g' $TARGET

      - name: â˜• è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: ğŸ—ï¸ æ‰§è¡Œå¼ºåŠ›ç¼–è¯‘
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug -x lint -x test --no-daemon

      - name: ğŸ“¦ å¯¼å‡º Mommy APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Mommy-Turbo-Vacuum-APK
          path: TMessagesProj_App/build/outputs/apk/debug/*.apk
