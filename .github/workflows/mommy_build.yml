name: Build Mommy Turbo Vacuum
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ æºç è¡¥ä¸ä¸å…¨é‡é‡æ„ (æš´åŠ›å¯¹é½ç‰ˆ)
        env:
          G_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          echo "ğŸš€ æ‰§è¡Œåœ°æ¯¯å¼ç‰©ç†é‡æ„ (å¼ºåˆ¶è¦†ç›–æ¨¡å¼)..."
          
          # 1. å¼ºåˆ¶åŒ…åæ›¿æ¢ï¼šç›´æ¥æ›¿æ¢æ‰€æœ‰å¯èƒ½çš„æ®‹ç•™å­—ç¬¦ä¸²
          # ä½¿ç”¨ "{""}" ç¡®ä¿ find å‘½ä»¤ä¸è¢«æ—¥å¿—è¿‡æ»¤å™¨æ‹¦æˆª
          find . -type f \( -name "*.gradle" -o -name "*.xml" -o -name "*.java" -o -name "*.json" \) -exec sed -i "s/tw.nekomimi.nekogram.beta/org.mommy.messenger/g" "{""}" +
          find . -type f \( -name "*.gradle" -o -name "*.xml" -o -name "*.java" -o -name "*.json" \) -exec sed -i "s/tw.nekomimi.nekogram/org.mommy.messenger/g" "{""}" +
          
          # é’ˆå¯¹ build.gradle è¿›è¡Œâ€œé™ç»´æ‰“å‡»â€ï¼š
          # ä¸ç®¡è¿™ä¸€è¡ŒåŸæ¥æ˜¯ tw... è¿˜æ˜¯è¢«æ‰“ç çš„ ***ï¼Œåªè¦åŒ¹é…åˆ° applicationId å°±æ•´è¡Œé‡å†™
          find . -name "build.gradle" -exec sed -i 's/applicationId .*/applicationId "org.mommy.messenger"/g' "{""}" +

          echo "âš¡ æ³¨å…¥ 32 çº¿ç¨‹ Turbo åŠ é€Ÿè¡¥ä¸..."
          find TMessagesProj/ -name "FileLoader.java" -exec sed -i 's/currentUploadOperationsCount < [0-9]*/currentUploadOperationsCount < 32/g' "{""}" +
          find TMessagesProj/ -name "FileLoadOperation.java" -exec sed -i 's/currentDownloadOperationsCount < [0-9]*/currentDownloadOperationsCount < 32/g' "{""}" +

          echo "ğŸ”‘ é”å®š API å‚æ•°..."
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.is[A-Za-z0-9]*([^)]*)/true/g' "{""}" +
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.APP_ID/37274250/g' "{""}" +
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.APP_HASH/"5205cbdae6cecc6ce1bd494b5685fe16"/g' "{""}" +

          echo "ğŸ“¦ æ³¨å…¥ç§æœ‰ Google Services é…ç½®..."
          if [ -n "$G_JSON" ]; then
            printf '%s' "$G_JSON" > TMessagesProj_App/google-services.json
            echo "âœ… ç§æœ‰ JSON æ³¨å…¥å®Œæˆ"
          else
            echo '{"project_info":{"project_id":"mommy"},"client":[{"client_info":{"client_id":"0"}}]}' > TMessagesProj_App/google-services.json
          fi

          echo "ğŸ“› åº”ç”¨ App åç§°æ›´å (Mommy)..."
          find . -name "strings.xml" -exec sed -i 's/Nekogram/Mommy/g' "{""}" +

          echo "ğŸ” ç‰©ç†è‡ªæ£€ (æ­£åœ¨éªŒè¯åŒ…åä¸çº¿ç¨‹)..."
          # è‡ªæ£€ build.gradle
          if grep -q "org.mommy.messenger" TMessagesProj_App/build.gradle; then
            echo "âœ… åŒ…åä¿®æ”¹æˆåŠŸ (build.gradle å¯¹é½)"
          else
            echo "âŒ åŒ…åä¿®æ”¹å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶æ³¨å…¥..."
            echo "android.defaultConfig.applicationId = 'org.mommy.messenger'" >> TMessagesProj_App/build.gradle
          fi
          
          # è‡ªæ£€ 32 çº¿ç¨‹
          grep "32" TMessagesProj/src/main/java/org/telegram/messenger/FileLoader.java && echo "âœ… 32çº¿ç¨‹è¡¥ä¸ç¡®è®¤ç”Ÿæ•ˆ"

      - name: â˜• è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: ğŸ—ï¸ æ‰§è¡Œ Gradle ç¼–è¯‘
        run: |
          chmod +x gradlew
          
          # ç‰©ç†æ¸…é™¤å¯èƒ½å¯¼è‡´ Gradle è¯­æ³•é”™è¯¯çš„æ‰“ç æ®‹ç•™
          sed -i '/\*\*\*/d' TMessagesProj_App/build.gradle
          
          ./gradlew assembleDebug -x lint -x test --no-daemon

      - name: ğŸ“¦ å¯¼å‡ºæœ€ç»ˆæˆå“ APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Mommy-Turbo-Vacuum-Final
          path: TMessagesProj_App/build/outputs/apk/debug/*.apk
