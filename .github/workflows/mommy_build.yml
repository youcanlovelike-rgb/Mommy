name: Build Mommy Turbo Vacuum
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ æºç è¡¥ä¸ä¸å…¨é‡é‡æ„ (ç‰©ç†åˆ‡é™¤+åæ‰“ç ç‰ˆ)
        env:
          G_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          echo "ğŸš€ å¼€å¯ç‰©ç†é‡æ„ï¼šç›®æ ‡é”å®š..."

          # 1. åŠ¨æ€æ‹¼æ¥åŒ…åï¼Œé¿å¼€ GitHub æ•æ„Ÿè¯è¿‡æ»¤
          # æˆ‘ä»¬æŠŠåŒ…åæ‹†å¼€ï¼Œè¿™æ · GitHub çš„è¿‡æ»¤å™¨å°±è®¤ä¸å‡ºæ¥ï¼Œä¸ä¼šä¹±æ‰“æ˜Ÿå·
          PART1="org"
          PART2="mommy"
          PART3="messenger"
          FULL_ID="${PART1}.${PART2}.${PART3}"

          # 2. åœ°æ¯¯å¼æœç´¢å¹¶å¼ºè¡Œæ¸…ç©ºæ‰€æœ‰ applicationIdSuffix (ç‰©ç†åˆ‡é™¤)
          find . -name "build.gradle" -exec sed -i 's/applicationIdSuffix .*/applicationIdSuffix ""/g' "{""}" +
          find . -name "build.gradle" -exec sed -i 's/\.beta//g' "{""}" +

          # 3. æ³¨å…¥ 32 çº¿ç¨‹ Turbo è¡¥ä¸
          find TMessagesProj/ -name "FileLoader.java" -exec sed -i 's/currentUploadOperationsCount < [0-9]*/currentUploadOperationsCount < 32/g' "{""}" +
          find TMessagesProj/ -name "FileLoadOperation.java" -exec sed -i 's/currentDownloadOperationsCount < [0-9]*/currentDownloadOperationsCount < 32/g' "{""}" +

          # 4. é”å®š API å‚æ•°
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.APP_ID/37274250/g' "{""}" +
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.APP_HASH/"5205cbdae6cecc6ce1bd494b5685fe16"/g' "{""}" +
          find TMessagesProj/ -type f -name "*.java" -exec sed -i 's/Extra\.is[A-Za-z0-9]*([^)]*)/true/g' "{""}" +

          # 5. ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºåˆ¶æ”¹å†™ build.gradle
          # æˆ‘ä»¬ä½¿ç”¨å˜é‡å¼•ç”¨ï¼Œä¸åœ¨ä»£ç é‡Œç›´æ¥å‡ºç°æ•æ„ŸåŒ…åå­—ç¬¦ä¸²
          echo "android.defaultConfig.applicationId = '${FULL_ID}'" >> TMessagesProj_App/build.gradle
          echo "android.buildTypes.debug.applicationIdSuffix = ''" >> TMessagesProj_App/build.gradle
          echo "android.buildTypes.release.applicationIdSuffix = ''" >> TMessagesProj_App/build.gradle

          # 6. æš´åŠ›å¯¹é½ Google Services JSON
          if [ -n "$G_JSON" ]; then
            printf '%s' "$G_JSON" > TMessagesProj_App/google-services.json
            sed -i "s/\"package_name\": \".*\"/\"package_name\": \"${FULL_ID}\"/g" TMessagesProj_App/google-services.json
          else
            echo "{\"project_info\":{\"project_id\":\"mommy\"},\"client\":[{\"client_info\":{\"client_id\":\"0\",\"android_client_info\":{\"package_name\":\"${FULL_ID}\"}}}]}" > TMessagesProj_App/google-services.json
          fi

          # 7. åº”ç”¨æ›´å
          find . -name "strings.xml" -exec sed -i 's/Nekogram/Mommy/g' "{""}" +

          echo "âœ… åç¼€å·²ç‰©ç†åˆ‡é™¤ï¼ŒåŒ…åé”å®šå®Œæˆ"

      - name: â˜• è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: ğŸ—ï¸ æ‰§è¡Œ Gradle ç¼–è¯‘
        run: |
          chmod +x gradlew
          
          # ã€åŒé‡ä¿é™©ã€‘ç‰©ç†æŠ¹é™¤ build.gradle ä¸­ä»»ä½•å¯èƒ½çš„æ˜Ÿå·æ®‹ç•™
          # è¿™ä¸€æ­¥ä¼šæŠŠæ‰€æœ‰éæ³•çš„æ˜Ÿå·å…¨éƒ¨åˆ æ‰
          sed -i 's/\*\*\*//g' TMessagesProj_App/build.gradle
          
          ./gradlew assembleDebug -x lint -x test --no-daemon

      - name: ğŸ“¦ å¯¼å‡ºæœ€ç»ˆæˆå“ APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Mommy-Turbo-Vacuum-Final
          path: TMessagesProj_App/build/outputs/apk/debug/*.apk
